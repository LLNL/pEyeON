{
  "$id": "observation.schema.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "EyeON Observation",
  "type": "object",
  "x-duckdb-table": "observations",
  "x-duckdb-pk": "uuid",
  "required": ["bytecount", "filename", "filetype", "magic", "md5", "observation_ts", "sha1", "sha256", "uuid"],
  "properties": {
    "bytecount": {
      "x-duckdb-type": "BIGINT",
      "type":"integer",
      "description": "Size of file in bytes"
    },
    "compiler": {
      "type": "string",
      "description": "Compiler Identifier"
    },
    "filename": {
      "type": "string",
      "description": "Basename of file"
    },
    "filetype": {
      "type": "string",
      "enum": ["ELF", "Malformed PE", "DOS", "Linux Kernel Image", "PE", "OLE", "MSCAB", "ISCAB", "DOCKER_GZIP", "GZIP", "BZIP2", "XZ", "DOCKER_TAR", "TAR", "RAR", "ZIP", "JAR", "WAR", "EAR", "APK", "IPA", "MSIX", "MACHOFAT", "JAVACLASS", "MACHOFAT", "MACHOFAT64", "EFIFAT", "MACHO32", "MACHO64", "LLVM_BITCODE", "LLVM_IR", "A.OUT big", "A.OUT little", "COFF", "XCOFF32", "XCOFF64", "ECOFF", "AR_LIB", "OMF_LIB", "UIMAGE", "ZLIB", "CPIO_BIN big", "CPIO_BIN little", "CPIO_ASCII_OLD", "CPIO_ASCII_NEW", "CPIO_ASCII_NEW_CRC", "ZSTANDARD", "ZSTANDARD_DICTIONARY", "ISO_9660_CD", "MACOS_DMG", "RPM Package"],
      "description": "Specific file types recognized by EyeON. These are grouped together in the metadata definitions based on the properties they have in common"
    },
    "imphash": {
      "type": "string",
      "description": "Import Hash calculated via pefile"
    },
    "telfhash": {
      "type": "string",
      "description": "Import hashing technique used on ELF files"
    },
    "magic": {
      "type": "string",
      "description": "`file` Magic output for given file"
    },
    "md5": {
      "type": "string",
      "description": "MD5 of file"
    },
    "modtime": {
      "type": "string",
      "description": "Last modified date"
    },
    "observation_ts": {
      "type": "string",
      "description": "Date and time file was scanned"
    },
    "parent": {
      "type": "string",
      "description": "Some yet-to-be-determined pointer to a parent file or something"
    },
    "permissions": {
      "type": "string",
      "description": "Permissions of file"
    },
    "sha1": {
      "type": "string",
      "description": "Sha1 of file"
    },
    "sha256": {
      "type": "string",
      "description": "Sha256 of file"
    },
    "ssdeep": {
      "type": "string",
      "description": "Ssdeep of file"
    },
    "target_os": {
      "type": "string",
      "description": "Operating system of target machine"
    },
    "uuid": {
      "type": "string",
      "description": "Universally Unique Identifier"
    },
    "authentihash": {
      "type": "string",
      "description": "Authentihash computed from signature hashing algorithm"
    },
    "authenticode_integrity": {
      "type": "string",
      "description": "Checks if signatures are OK and if digest matches hashed authenticode"
    },
    "metadata": {
      "type": "object",
      "x-duckdb-discriminator": "filetype",
      "x-duckdb-polymorphic-strategy": "single-table",
      "x-duckdb-table": "base_metadata",
      "oneOf": [
        { 
          "$ref": "#/$defs/AOUTMetadata",
          "x-duckdb-table": "aout_metadata",
          "x-duckdb-pk": "observation_uuid",
          "x-duckdb-when": ["A.OUT big", "A.OUT little"]
        },
        { 
          "$ref": "#/$defs/CoffMetadata",
          "x-duckdb-table": "coff_metadata",
          "x-duckdb-pk": "observation_uuid",
          "x-duckdb-when": ["COFF", "XCOFF32", "XCOFF64", "ECOFF"]
        },
        { 
          "$ref": "#/$defs/DockerImageMetadata",
          "x-duckdb-table": "docker_metadata",
          "x-duckdb-pk": "observation_uuid",
          "x-duckdb-when": ["DOCKER_GZIP", "DOCKER_TAR"]
        },
        { 
          "$ref": "#/$defs/ELFMetadata",
          "x-duckdb-table": "elf_metadata",
          "x-duckdb-pk": "observation_uuid",
          "x-duckdb-when": ["ELF", "Linux Kernel Image"]
        },
        { 
          "$ref": "#/$defs/JavaMetadata",
          "x-duckdb-table": "java_metadata",
          "x-duckdb-pk": "observation_uuid",
          "x-duckdb-when": ["JAVACLASS", "JAR", "WAR", "EAR", "APK"]
        },
        { 
          "$ref": "#/$defs/JavascriptMetadata",
          "x-duckdb-table": "javascript_metadata",
          "x-duckdb-pk": "observation_uuid",
          "x-duckdb-when": []
        },
        { 
          "$ref": "#/$defs/MachOMetadata",
          "x-duckdb-table": "macho_metadata",
          "x-duckdb-pk": "observation_uuid",
          "x-duckdb-when": ["MACHOFAT", "MACHOFAT64", "EFIFAT", "MACHO32", "MACHO64", "IPA", "MACOS_DMG"]
        },
        { 
          "$ref": "#/$defs/NativeMetadata",
          "x-duckdb-table": "native_metadata",
          "x-duckdb-pk": "observation_uuid",
          "x-duckdb-when": ["LLVM_BITCODE", "LLVM_IR"]
        },
        { 
          "$ref": "#/$defs/OleMetadata",
          "x-duckdb-table": "ole_metadata",
          "x-duckdb-pk": "observation_uuid",
          "x-duckdb-when": ["OLE", "MSCAB", "ISCAB", "MSIX"]
        },
        { 
          "$ref": "#/$defs/PEMetadata",
          "x-duckdb-table": "pe_metadata",
          "x-duckdb-pk": "observation_uuid",
          "x-duckdb-when": ["PE", "Malformed PE", "DOS"]
        },
        { 
          "$ref": "#/$defs/RPMMetadata",
          "x-duckdb-table": "rpm_metadata",
          "x-duckdb-pk": "observation_uuid",
          "x-duckdb-when": ["RPM Package"]
        },
        { 
          "$ref": "#/$defs/UbootImageMetadata",
          "x-duckdb-table": "uboot_metadata",
          "x-duckdb-pk": "observation_uuid",
          "x-duckdb-when": ["UIMAGE"]
        },
        { 
          "$ref": "#/$defs/OtherMetadata",
          "x-duckdb-table": "other_metadata",
          "x-duckdb-pk": "observation_uuid",
          "x-duckdb-when": ["GZIP", "BZIP2", "XZ", "TAR", "RAR", "ZIP", "AR_LIB", "OMF_LIB", "ZLIB", "CPIO_BIN big", "CPIO_BIN little", "CPIO_ASCII_OLD", "CPIO_ASCII_NEW", "CPIO_ASCII_NEW_CRC", "ZSTANDARD", "ZSTANDARD_DICTIONARY", "ISO_9660_CD"]
        }
      ]
    },
    "signatures": {
      "type": "array",
      "x-duckdb-table": "signatures",
      "x-duckdb-fk": "observation_uuid",
      "x-duckdb-pk": "signature_id",
      "x-duckdb-pk-type": "VARCHAR",
      "items": {
        "type": "object",
        "properties": {
          "certs": {
            "$ref": "#/$defs/certs",
            "x-duckdb-table": "certificates",
            "x-duckdb-fk": "signature_id",
            "x-duckdb-pk": "certificate_id",
            "x-duckdb-pk-type": "integer",
            "x-duckdb-pk-seq": "certificate_seq"
          },
          "signers": { "type": "string" },
          "digest_algorithm": { "type": "string" },
          "verification": { "type": "string" },
          "sha1": { "type": "string" }
        },
        "required": ["signers", "digest_algorithm"]
      }
    },
    "checksum_verification": {
      "type": "object",
      "x-duckdb-flatten": true,
      "properties": {
          "algorithm": { "type": "string" },
          "expected": { "type": "string" },
          "actual": { "type": "string" },
          "verified": { "type": "boolean" }
      },
      "required": ["algorithm", "expected", "actual", "verified"]
    }
  },
  "additionalProperties": false,
  "$defs": {
    "certs": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "sha256": { "type": "string" }, 
          "issuer_sha256": { "type": "string" }, 
          "cert._version": { "type": "string" },
          "serial_number": { "type": "string" },
          "issuer_name": { "type": "string" },
          "subject_name": { "type": "string" },
          "issued_on": { "type": "string"},
          "expires_on": { "type": "string"},
          "signed_using": { "type": "string" },
          "RSA_key_size": { "type": "string" },
          "basic_constraints": { "type": "string" },
          "key_usage": { "type": "string" },
          "ext_key_usage": { "type": "string" },
          "certificate_policies": { "type": "string" }
       }
     }
    },
    "AOUTMetadata": {
      "type": "object",
      "required": [ "aoutMachineType" ],
      "properties": {
        "aoutMachineType": { "type": "string" }
      }
    },
    "CoffMetadata": {
      "type": "object",
      "required":  ["coffMachineType" ],
      "properties": {
        "coffMachineType": {"type": "string"}
      }
    },
    "DockerImageMetadata": {
      "type": "object",
      "required": ["dockerSPDX"],
      "properties": {
        "dockerSPDX": { 
          "type": "object",
          "properties": {
            "spdxVersion": {"type": "string"},
            "dataLicense": {"type": "string"},
            "SPDXID": {"type": "string"},
            "name": {"type": "string"},
            "documentNamespace": {"type": "string"},
            "creationInfo": {
              "type": "object",
              "properties": {
                "creators": {"type": "array"},
                "created": {"type": "string"}
              }
            },
            "packages": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "name": {"type": "string"},
                  "SPDXID": {"type": "string"},
                  "supplier": {"type": "string"},
                  "downloadLocation": {"type": "string"},
                  "filesAnalyzed": {"type": "boolean"},
                  "licenseConcluded": {"type": "string"}
                }
              }
            },
            "files": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "fileName": {"type": "string"},
                  "SPDXID": {"type": "string"},
                  "checksums": {
                    "type": "array",
                    "algorithm": {"type": "string"},
                    "checksumValue": {"type": "string"}
                  },
                  "licenseConcluded": {"type": "string"},
                  "copyrightText": {"type": "string"},
                  "comment": {"type": "string"},
                  "annotations": {
                    "type": "array",
                    "annotator": {"type": "string"},
                    "annotationDate": {"type": "string"},
                    "annotationType": {"type": "string"},
                    "comment": {"type": "string"}
                  }
                }
              }
            },
            "relationships": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "spdxElementId": {"type": "string"},
                  "relatedSpdxElement": {"type": "string"},
                  "relationshipType": {"type": "string"}
                }
              }
            }
          }
        }
      }
    },
    "ELFMetadata": {
      "type": "object",
      "required": ["elfIdent", "elfDependencies"],
      "properties": {
        "OS": { "type": "string" },
        "elfIdent": {
          "type": "object",
          "x-duckdb-flatten": true,
          "properties": {
            "EI_CLASS": { "type": "integer" },
            "EI_DATA": { "type": "integer" },
            "EI_VERSION": { "type": "integer" },
            "EI_OSABI": { "type": "integer" },
            "EI_ABIVERSION": { "type": "integer" },
            "E_MACHINE": { "type": "integer" }
          }
        },
        "elfDependencies": { 
          "type": "array",
          "x-duckdb-array": true
        },
        "elfRpath": { 
          "type": "array",
          "x-duckdb-array": true
        },
        "elfRunpath": { 
          "type": "array",
          "x-duckdb-array": true
        },
        "elfSoname": { 
          "type": "array",
          "x-duckdb-array": true
        },
        "elfInterpreter": { 
          "type": "array",
          "x-duckdb-array": true
        },
        "elfDynamicFlags": { 
          "type": "array",
          "x-duckdb-array": true
        },
        "elfDynamicFlags1": { 
          "type": "array",
          "x-duckdb-array": true
        },
        "elfGnuRelro": { "type": "boolean" },
        "elfComment": { 
          "type": "array",
          "x-duckdb-array": true
        },
        "elfNote": { 
          "type": "array",
          "x-duckdb-array": true
        },
        "elfOsAbi": { "type": "string" },
        "elfHumanArch": { "type": "string" },
        "elfArchNumber": { "type": "integer" },
        "elfArchitecture": { "type": "string" },
        "elfIsExe": { "type": "boolean" },
        "elfIsLib": { "type": "boolean" },
        "elfIsRel": { "type": "boolean" },
        "elfIsCore": { "type": "boolean" }
      }
    },
    "JavaMetadata": {
      "type": "object",
      "required": ["javaClasses"],
      "javaClasses": {
        "type": "array",
        "x-duckdb-array": true,
        "items": {
          "type": "object",
          "properties": {
            "className": { "type": "string" },
            "javaMinSEVersion": { "type": "string" },
            "javaExports": {
              "type": "array",
              "items": {
                "type": "string"
              }
            }
          },
          "javaImports": {
            "type": "array",
            "items": {
              "type": "string"
            }
          }
        }
      }
    },
    "JavascriptMetadata": {
      "type": "object",
      "required": ["jsLibraries"],
      "properties": {
        "jsLibraries": {
            "type": "array",
            "x-duckdb-array": true
        }
      }
    },
    "MachOMetadata": {
      "type": "object",
      "required": ["numBinaries", "binaries"],
      "properties": {
        "OS": { "type": "string" },
        "numBinaries": { "type": "integer" },
        "binaries": {
          "type": "array",
          "x-duckdb-json": true,
          "items": {
            "type": "object",
            "properties": {
              "format": { "type": "string" },
              "header": {
                "type": "object",
                "properties": {
                  "cpuType": { "type": "string" },
                  "cpuTypeValue": { "type": "integer" },
                  "cpuSubtype": { "type": "string" },
                  "cpuSubtypeValue": { "type": "integer" },
                  "fileType": { "type": "string" },
                  "fileTypeValue": { "type": "integer" },
                  "flags": { "type": "array" },
                  "numCommands": { "type": "integer" }
                }
              },
              "build": {
                "type": "object",
                "properties": {
                  "platform": { "type": "string" },
                  "platformValue": { "type": "integer" },
                  "minOSVersion": { "type": "string" },
                  "sdkVersion": { "type": "string" },
                  "tools": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "tool": { "type": "string" },
                        "version": { "type": "string" }
                      }
                    }
                  }
                }
              },
              "signature": {
                "type": "object",
                "properties": {
                  "offset": { "type":"integer" },
                  "size": { "type":"integer" },
                  "type": { "type":"string" }
                }
              },
              "dependencies": {
                "type": "array",
                "items": {
                  "name": { "type": "string" },
                  "currentVersion": { "type": "string" },
                  "compatibilityVersion": { "type": "string" }
                }
              },
              "rpaths": {
                "type": "array",
                "items": { "type": "string" }
              },
              "dyld": {
                "type": "object",
                "properties": {
                  "linker": { "type": "string" }
                }
              },
              "encryption": { "type": "object" }
            }
          }
        }
      }
    },
    "NativeMetadata": {
      "type": "object",
      "required": ["nativeLibraries"],
      "properties": {
        "nativeLibraries": { "type": "array" }
      }
    },
    "OleMetadata": {
      "type": "object",
      "required": ["ole"],
      "properties": {
          "ole": { 
            "type": "object",
            "properties": {
            "clsid": { "type": "string" },
            "clsid_type": { "type": "string" },
            "codepage": { "type": "string" },
            "title": { "type": "string" },
            "author": { "type": "string" },
            "template": { "type": "string" },
            "revision_number": { "type": "string" },
            "last_printed": { "type": "string" },
            "create_time": { "type": "string" },
            "last_saved_time": { "type": "string" },
            "num_pages": { "type": "string" },
            "num_words": { "type": "string" },
            "creating_application": { "type": "string" },
            "security": { "type": "string" }
          }
        }
      }
    },
    
    "PEMetadata": {
      "type": "object",
      "required": ["peMachine"],
      "properties": {
        "OS": { "type": "string" },
        "peMachine": { "type": "string" },
        "peOperatingSystemVersion": { "type": "string" },
        "peSubsystemVersion": { "type": "string" },
        "peSubsystem": { "type": "string" },
        "peLinkerVersion": { "type": "string" },
        "peImport": { "type": "array",
            "x-duckdb-array": true,
            "items": { "type": "string" }
        },
        "peIsExe": { "type": "boolean" }, 
        "peIsDll": { "type": "boolean" }, 
        "peIsClr": { "type": "boolean" }, 
        "FileInfo": { "type": "object" }, 
        "dllRedirectionLocal": { "type": "boolean" }
      }

    },
    "RPMMetadata": {
      "type": "object",
      "required": ["rpm"],
      "properties": {
        "rpm": { 
          "type": "object",
          "properties": {
            "name": { "type": "string" },
            "sourcerpm": { "type": "string" },
            "version": { "type": "string" },
            "release": { "type": "string" },
            "summary": { "type": "string" },
            "description": { "type": "string" },
            "rpmversion": { "type": "string"},
            "copyright": { "type": "string"},
            "os": { "type": "string"},
            "arch": { "type": "string"},
            "target": { "type": "string"},
            "archive_format": { "type": "string"},
            "archive_compression": { "type": "string"},
            "optflags": { "type": "string"},
            "sha256": { "type": "string"},
            "md5": { "type": "string"},
            "requirename": {
              "type": "object"
            },
            "provides": {
              "type": "object"
            },
            "buildtime": { "type": "integer"},
            "associated_files": {
              "type": "object"
            }
          }
        }
      }
    },
    "UbootImageMetadata": {
      "type": "object",
      "required": ["uimage_header"],
      "properties": {
        "uimage_header": { 
          "type": "object",
          "header_crc": { "type": "string" },
          "timestamp" : { "type": "integer" },
          "data_size" : { "type": "integer" },
          "load_addr" : { "type": "string" },
          "entry_point" : { "type": "string" },
          "data_crc" : { "type": "string" },
          "os" : { "type": "string" },
          "os_description" : { "type": "string" },
          "arch" : { "type": "string" },
          "arch_description" : { "type": "string" },
          "image_type" : { "type": "string" },
          "image_type_description" : { "type": "string" },
          "compression_type" : { "type": "string" },
          "name" : { "type": "string" }
        }
      }
    },
    "OtherMetadata": {
      "type": "object",
      "required": ["description"],
      "properties": {
        "description": { "type": "string" }
      }
    }
  }
}
