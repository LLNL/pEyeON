{
  "$id": "observation.schema.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "EyeON Observation",
  "type": "object",
  "x-duckdb-table": "observations",
  "x-duckdb-pk": "uuid",
  "required": ["bytecount", "filename", "filetype", "magic", "md5", "observation_ts", "sha1", "sha256", "uuid"],
  "properties": {
    "bytecount": {
      "type":"integer",
      "description": "Size of file in bytes"
    },
    "compiler": {
      "type": "string",
      "description": "Compiler Identifier"
    },
    "filename": {
      "type": "string",
      "description": "Basename of file"
    },
    "filetype": {
      "type": "string",
      "enum": ["ELF", "Malformed PE", "DOS", "Linux Kernel Image", "PE", "OLE", "MSCAB", "ISCAB", "DOCKER_GZIP", "GZIP", "BZIP2", "XZ", "DOCKER_TAR", "TAR", "RAR", "ZIP", "JAR", "WAR", "EAR", "APK", "IPA", "MSIX", "MACHOFAT", "JAVACLASS", "MACHOFAT", "MACHOFAT64", "EFIFAT", "MACHO32", "MACHO64", "LLVM_BITCODE", "LLVM_IR", "A.OUT big", "A.OUT little", "COFF", "XCOFF32", "XCOFF64", "ECOFF", "AR_LIB", "OMF_LIB", "UIMAGE", "ZLIB", "CPIO_BIN big", "CPIO_BIN little", "CPIO_ASCII_OLD", "CPIO_ASCII_NEW", "CPIO_ASCII_NEW_CRC", "ZSTANDARD", "ZSTANDARD_DICTIONARY", "ISO_9660_CD", "MACOS_DMG", "RPM Package"]
    },
    "imphash": {
      "type": "string",
      "description": "Import Hash calculated via pefile"
    },
    "telfhash": {
      "type": "string",
      "description": "Import hashing technique used on ELF files"
    },
    "magic": {
      "type": "string",
      "description": "`file` Magic output for given file"
    },
    "md5": {
      "type": "string",
      "description": "MD5 of file"
    },
    "modtime": {
      "type": "string",
      "description": "Last modified date"
    },
    "observation_ts": {
      "type": "string",
      "description": "Date and time file was scanned"
    },
    "parent": {
      "type": "string",
      "description": "Some yet-to-be-determined pointer to a parent file or something"
    },
    "permissions": {
      "type": "string",
      "description": "Permissions of file"
    },
    "sha1": {
      "type": "string",
      "description": "Sha1 of file"
    },
    "sha256": {
      "type": "string",
      "description": "Sha256 of file"
    },
    "ssdeep": {
      "type": "string",
      "description": "Ssdeep of file"
    },
    "target_os": {
      "type": "string",
      "description": "Operating system of target machine"
    },
    "uuid": {
      "type": "string",
      "description": "Universally Unique Identifier"
    },
    "authentihash": {
      "type": "string",
      "description": "Authentihash computed from signature hashing algorithm"
    },
    "authenticode_integrity": {
      "type": "string",
      "description": "Checks if signatures are OK and if digest matches hashed authenticode"
    },
    "metadata": {
      "type": "object",
      "x-duckdb-discriminator": "filetype",
      "oneOf": [
        { 
          "$ref": "#/$defs/PEMetadata",
          "x-duckdb-table": "pe_metadata",
          "x-duckdb-pk": "observation_uuid",
          "x-duckdb-when": ["PE", "Malformed PE"]
        },
        { 
          "$ref": "#/$defs/ELFMetadata",
          "x-duckdb-table": "elf_metadata",
          "x-duckdb-pk": "observation_uuid",
          "x-duckdb-when": ["ELF"]
        },
        { 
          "$ref": "#/$defs/MachOMetadata",
          "x-duckdb-table": "macho_metadata",
          "x-duckdb-pk": "observation_uuid",
          "x-duckdb-when": ["MACHOFAT", "MACHOFAT64", "EFIFAT", "MACHO32", "MACHO64"]
        },
        { 
          "$ref": "#/$defs/CoffMetadata",
          "x-duckdb-table": "coff_metadata",
          "x-duckdb-pk": "observation_uuid",
          "x-duckdb-when": ["COFF"]
        },
        { 
          "$ref": "#/$defs/JavaMetadata",
          "x-duckdb-table": "java_metadata",
          "x-duckdb-pk": "observation_uuid",
          "x-duckdb-when": ["JAVACLASS", "JAR", "WAR", "EAR"]
        },
        { 
          "$ref": "#/$defs/AOUTMetadata",
          "x-duckdb-table": "aout_metadata",
          "x-duckdb-pk": "observation_uuid",
          "x-duckdb-when": ["A.OUT big", "A.OUT little"]
        },
        { 
          "$ref": "#/$defs/blahMetadata",
          "x-duckdb-table": "blah_metadata",
          "x-duckdb-pk": "observation_uuid",
          "x-duckdb-when": ["BLAH"]
        },
        { 
          "$ref": "#/$defs/somethingelseMetadata",
          "x-duckdb-table": "somethingelse_metadata",
          "x-duckdb-pk": "observation_uuid",
          "x-duckdb-when": ["SOMETHINGELSE"]
        },
        { 
          "$ref": "#/$defs/OtherMetadata",
          "x-duckdb-table": "other_metadata",
          "x-duckdb-pk": "observation_uuid",
          "x-duckdb-when": []
        }
      ]
    },
    "defaults": {
      "$ref": "#/$defs/defaults",
      "x-duckdb-flatten": true
    },
    "signatures": {
      "type": "array",
      "x-duckdb-table": "signatures",
      "x-duckdb-fk": "observation_uuid",
      "x-duckdb-pk": "signature_id",
      "x-duckdb-pk-type": "INTEGER",
      "items": {
        "type": "object",
        "properties": {
          "certs": {
            "$ref": "#/$defs/certs",
            "x-duckdb-table": "certificates",
            "x-duckdb-fk": "signature_id",
            "x-duckdb-pk": "sha256"
          },
          "signers": { "type": "string" },
          "digest_algorithm": { "type": "string" },
          "verification": { "type": "string" },
          "sha1": { "type": "string" }
        },
        "required": ["signers", "digest_algorithm"]
      }
    },
    "detect_it_easy": {
      "type": "string",
      "description": "Program that determines types of files for Windows, Linux and MacOS"
    }
  },
  "additionalProperties": false,
  "$defs": {
    "certs": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "sha256": { "type": "string" }, 
          "issuer_sha256": { "type": "string" }, 
          "cert_version": { "type": "string" },
          "serial_number": { "type": "string" },
          "issuer_name": { "type": "string" },
          "subject_name": { "type": "string" },
          "issued_on": { "type": "string"},
          "expires_on": { "type": "string"},
          "signed_using": { "type": "string" },
          "RSA_key_size": { "type": "string" },
          "basic_constraints": { "type": "string" },
          "key_usage": { "type": "string" },
          "ext_key_usage": { "type": "string" },
          "certificate_policies": { "type": "string" }
       }
     }
    },
    "CoffMetadata": {
      "type": "object",
      "required": ["coffMachineType"],
      "properties": {
        "coffMachineType": {"type": "string"}
      }
    },
    "PEMetadata": {
      "type": "object",
      "required": ["peMachine"],
      "properties": {
        "OS": { "type": "string" },
        "peMachine": { "type": "string" },
        "peOperatingSystemVersion": { "type": "string" },
        "peSubsystemVersion": { "type": "string" },
        "peSubsystem": { "type": "string" },
        "peLinkerVersion": { "type": "string" },
        "peImport": { 
          "type": "array",
          "x-duckdb-array": true,
          "items": { "type": "string" }
        },
        "peIsExe": { "type": "boolean" }, 
        "peIsDll": { "type": "boolean" }, 
        "peIsClr": { "type": "boolean" }, 
        "FileInfo": { 
          "type": "object",
          "x-duckdb-flatten": true,
          "properties": {
            "CompanyName": { "type": "string" },
            "FileDescription": { "type": "string" },
            "FileVersion": { "type": "string" },
            "LegalCopyright": { "type": "string" },
            "ProductName": { "type": "string" },
            "ProductVersion": { "type": "string" }
          }
        }, 
        "dllRedirectionLocal": { "type": "boolean" }
      }
    },
    "ELFMetadata": {
      "type": "object",
      "required": ["elfIdent", "elfDependencies"],
      "properties": {
        "OS": { "type": "string" },
        "elfIdent": {
          "type": "object",
          "x-duckdb-flatten": true,
          "properties": {
            "EI_CLASS": { "type": "integer" },
            "EI_DATA": { "type": "integer" },
            "EI_VERSION": { "type": "integer" },
            "EI_OSABI": { "type": "integer" },
            "EI_ABIVERSION": { "type": "integer" },
            "E_MACHINE": { "type": "integer" }
          }
        },
        "elfDependencies": { 
          "type": "array",
          "x-duckdb-array": true
        },
        "elfRpath": { 
          "type": "array",
          "x-duckdb-array": true
        },
        "elfRunpath": { 
          "type": "array",
          "x-duckdb-array": true
        },
        "elfSoname": { 
          "type": "array",
          "x-duckdb-array": true
        },
        "elfInterpreter": { 
          "type": "array",
          "x-duckdb-array": true
        },
        "elfDynamicFlags": { 
          "type": "array",
          "x-duckdb-array": true
        },
        "elfDynamicFlags1": { 
          "type": "array",
          "x-duckdb-array": true
        },
        "elfGnuRelro": { "type": "boolean" },
        "elfComment": { 
          "type": "array",
          "x-duckdb-array": true
        },
        "elfNote": { 
          "type": "array",
          "x-duckdb-array": true
        },
        "elfOsAbi": { "type": "string" },
        "elfHumanArch": { "type": "string" },
        "elfArchNumber": { "type": "integer" },
        "elfArchitecture": { "type": "string" },
        "elfIsExe": { "type": "boolean" },
        "elfIsLib": { "type": "boolean" },
        "elfIsRel": { "type": "boolean" },
        "elfIsCore": { "type": "boolean" }
      }
    },
    "MachOMetadata": {
      "type": "object",
      "required": ["numBinaries", "binaries"],
      "properties": {
        "OS": { "type": "string" },
        "numBinaries": { "type": "integer" },
        "binaries": {
          "type": "array",
          "x-duckdb-json": true,
          "items": {
            "type": "object",
            "properties": {
              "format": { "type": "string" },
              "header": {
                "type": "object",
                "properties": {
                  "cpuType": { "type": "string" },
                  "cpuTypeValue": { "type": "integer" },
                  "cpuSubtype": { "type": "string" },
                  "cpuSubtypeValue": { "type": "integer" },
                  "fileType": { "type": "string" },
                  "fileTypeValue": { "type": "integer" },
                  "flags": { "type": "array" },
                  "numCommands": { "type": "integer" }
                }
              },
              "build": {
                "type": "object",
                "properties": {
                  "platform": { "type": "string" },
                  "platformValue": { "type": "integer" },
                  "minOSVersion": { "type": "string" },
                  "sdkVersion": { "type": "string" },
                  "tools": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "tool": { "type": "string" },
                        "version": { "type": "string" }
                      }
                    }
                  }
                }
              },
              "signature": {
                "type": "object",
                "properties": {
                  "offset": { "type":"integer" },
                  "size": { "type":"integer" },
                  "type": { "type":"string" }
                }
              },
              "dependencies": {
                "type": "array",
                "items": {
                  "name": { "type": "string" },
                  "currentVersion": { "type": "string" },
                  "compatibilityVersion": { "type": "string" }
                }
              },
              "rpaths": {
                "type": "array",
                "items": { "type": "string" }
              },
              "dyld": {
                "type": "object",
                "properties": {
                  "linker": { "type": "string" }
                }
              },
              "encryption": { "type": "object" }
            }
          }
        }
      }
    },
    "JavaMetadata": {
      "type": "object",
      "properties": {
        "javaVersion": { "type": "string" }
      }
    },
    "AOUTMetadata": {
      "type": "object",
      "properties": {
        "aoutMagic": { "type": "string" }
      }
    },
    "blahMetadata": {
      "type": "object",
      "properties": {
        "blahField": { "type": "string" }
      }
    },
    "somethingelseMetadata": {
      "type": "object",
      "properties": {
        "someField": { "type": "string" }
      }
    },
    "OtherMetadata": {
      "type": "object",
      "required": ["description"],
      "properties": {
        "description": { "type": "string" }
      }
    },
    "defaults": {
      "type": "object",
      "properties": {
        "default_filename": { "type": "string" },
        "manufacturer_org": { "type": "string" },
        "location": {
          "type": "object",
          "x-duckdb-flatten": true,
          "properties": {
            "location": { "type": "string" },
            "filelocation": { "type": "string" }
          }
        },
        "machines": {
          "type": "object",
          "x-duckdb-flatten": true,
          "properties": {
            "machines": { "type": "string" },
            "os": { "type": "string" },
            "version": { "type": "string" },
            "x-version": { "type": "string" }
          }
        }
      }
    }
  }
}